var ue=Object.defineProperty;var K=Object.getOwnPropertySymbols;var ce=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable;var q=(e,l,t)=>l in e?ue(e,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[l]=t,z=(e,l)=>{for(var t in l||(l={}))ce.call(l,t)&&q(e,t,l[t]);if(K)for(var t of K(l))pe.call(l,t)&&q(e,t,l[t]);return e};var b=(e,l,t)=>new Promise((s,o)=>{var u=p=>{try{c(t.next(p))}catch(F){o(F)}},d=p=>{try{c(t.throw(p))}catch(F){o(F)}},c=p=>p.done?s(p.value):Promise.resolve(p.value).then(u,d);c((t=t.apply(e,l)).next())});import{u as fe}from"./column.esm-ObKttWdy.js";import{d as ge,a as m,S as J,t as W,y as me,m as he,w as $,b as a,c as y,p as L,e as w,C as h,u as _,F as X,H as Y,n as O,o as v}from"./vue-vendor-DAChQ3rz.js";import{g as x,_ as ve,b as ye}from"../assets/index-wFKlhvRq.js";import{s as _e}from"./dialog.esm-CYAWXk5o.js";import{s as Fe}from"./fileupload.esm-BgVAjcEe.js";import{s as R}from"./button.esm-tVDeXX10.js";import{s as Z}from"./dropdown.esm-DKpLOg4v.js";import{s as be}from"./inputtext.esm-DAhs_0Nh.js";import{s as we}from"./progressbar.esm-Cqhb3WYw.js";const Ue=ge("files",{state:()=>({files:[],currentFile:null,uploadQueue:[],loading:!1,uploading:!1,error:null,categories:["blueprints","documents","images","reports","contracts","invoices","other"],supportedFormats:{images:["jpg","jpeg","png","gif","webp","svg"],documents:["pdf","doc","docx","txt","rtf"],blueprints:["dwg","pdf","jpg","png","tiff"],spreadsheets:["xls","xlsx","csv"],archives:["zip","rar","7z"],other:["*"]},maxFileSize:50*1024*1024,pagination:{current_page:1,per_page:20,total:0,last_page:1},filters:{search:"",category:"",project_id:null,file_type:"",date_from:null,date_to:null}}),getters:{filteredFiles:e=>{let l=[...e.files];if(e.filters.search){const t=e.filters.search.toLowerCase();l=l.filter(s=>{var o;return s.original_name.toLowerCase().includes(t)||((o=s.description)==null?void 0:o.toLowerCase().includes(t))})}return e.filters.category&&(l=l.filter(t=>t.category===e.filters.category)),e.filters.project_id&&(l=l.filter(t=>t.project_id===e.filters.project_id)),e.filters.file_type&&(l=l.filter(t=>t.file_type===e.filters.file_type)),l},filesByProject:e=>l=>e.files.filter(t=>t.project_id===l),filesByCategory:e=>l=>e.files.filter(t=>t.category===l),imageFiles:e=>e.files.filter(l=>{var t;return e.supportedFormats.images.includes((t=l.file_extension)==null?void 0:t.toLowerCase())}),documentFiles:e=>e.files.filter(l=>{var t;return e.supportedFormats.documents.includes((t=l.file_extension)==null?void 0:t.toLowerCase())}),uploadProgress:e=>{if(e.uploadQueue.length===0)return 0;const l=e.uploadQueue.length,t=e.uploadQueue.filter(s=>s.status==="completed").length;return Math.round(t/l*100)},fileStats:e=>{const l={total:e.files.length,by_category:{},by_type:{},total_size:0};return e.files.forEach(t=>{var o;l.by_category[t.category]||(l.by_category[t.category]=0),l.by_category[t.category]++;const s=((o=t.file_extension)==null?void 0:o.toLowerCase())||"unknown";l.by_type[s]||(l.by_type[s]=0),l.by_type[s]++,l.total_size+=t.file_size||0}),l},isFileTypeSupported:e=>l=>{var s;const t=(s=l.split(".").pop())==null?void 0:s.toLowerCase();return Object.values(e.supportedFormats).some(o=>o.includes(t)||o.includes("*"))},getFileCategory:e=>l=>{var s;const t=(s=l.split(".").pop())==null?void 0:s.toLowerCase();for(const[o,u]of Object.entries(e.supportedFormats))if(u.includes(t))return o;return"other"}},actions:{fetchFiles(){return b(this,arguments,function*(e={}){var l,t;this.loading=!0,this.error=null;try{const s=z(z({page:e.page||this.pagination.current_page,per_page:e.per_page||this.pagination.per_page},this.filters),e.filters);Object.keys(s).forEach(u=>{(s[u]===""||s[u]===null||s[u]===void 0)&&delete s[u]});const o=yield x.get("/files",{params:s});return this.files=o.data.data,this.pagination={current_page:o.data.meta.current_page,per_page:o.data.meta.per_page,total:o.data.meta.total,last_page:o.data.meta.last_page},o.data}catch(s){throw this.error=((t=(l=s.response)==null?void 0:l.data)==null?void 0:t.message)||"Failed to fetch files",console.error("Fetch files error:",s),s}finally{this.loading=!1}})},fetchFile(e){return b(this,null,function*(){var l,t;this.loading=!0,this.error=null;try{const s=yield x.get(`/files/${e}`);return this.currentFile=s.data.data,s.data.data}catch(s){throw this.error=((t=(l=s.response)==null?void 0:l.data)==null?void 0:t.message)||"Failed to fetch file",console.error("Fetch file error:",s),s}finally{this.loading=!1}})},uploadFiles(s,o){return b(this,arguments,function*(e,l,t={}){this.uploading=!0,this.error=null;const u=Array.from(e).map(d=>z({id:`upload_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,file:d,projectId:l,status:"pending",progress:0,error:null,result:null},t));this.uploadQueue.push(...u);try{const d=u.map(c=>this.uploadSingleFile(c));return yield Promise.allSettled(d),yield this.fetchFiles(),u.filter(c=>c.status==="completed").map(c=>c.result)}catch(d){throw this.error=d.message||"Upload failed",console.error("Upload error:",d),d}finally{this.uploading=!1}})},uploadSingleFile(e){return b(this,null,function*(){var u,d;const{file:l,projectId:t,category:s,description:o}=e;if(!this.isFileTypeSupported(l.name))throw e.status="error",e.error="File type not supported",new Error("File type not supported");if(l.size>this.maxFileSize)throw e.status="error",e.error="File size too large",new Error("File size too large");try{e.status="uploading";const c=new FormData;c.append("file",l),c.append("project_id",t),c.append("category",s||this.getFileCategory(l.name)),o&&c.append("description",o);const p=yield x.post("/files",c,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:F=>{e.progress=Math.round(F.loaded*100/F.total)}});return e.status="completed",e.result=p.data.data,this.files.unshift(p.data.data),p.data.data}catch(c){throw e.status="error",e.error=((d=(u=c.response)==null?void 0:u.data)==null?void 0:d.message)||"Upload failed",console.error("Single file upload error:",c),c}})},deleteFile(e){return b(this,null,function*(){var l,t,s;this.loading=!0,this.error=null;try{yield x.delete(`/files/${e}`),this.files=this.files.filter(o=>o.id!==e),((l=this.currentFile)==null?void 0:l.id)===e&&(this.currentFile=null)}catch(o){throw this.error=((s=(t=o.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to delete file",console.error("Delete file error:",o),o}finally{this.loading=!1}})},updateFile(e,l){return b(this,null,function*(){var t,s,o;this.loading=!0,this.error=null;try{const d=(yield x.put(`/files/${e}`,l)).data.data,c=this.files.findIndex(p=>p.id===e);return c!==-1&&(this.files[c]=d),((t=this.currentFile)==null?void 0:t.id)===e&&(this.currentFile=d),d}catch(u){throw this.error=((o=(s=u.response)==null?void 0:s.data)==null?void 0:o.message)||"Failed to update file",console.error("Update file error:",u),u}finally{this.loading=!1}})},downloadFile(e,l){return b(this,null,function*(){var t,s;try{const o=yield x.get(`/files/${e}/download`,{responseType:"blob"}),u=window.URL.createObjectURL(new Blob([o.data])),d=document.createElement("a");d.href=u,d.download=l||`file_${e}`,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(u)}catch(o){throw this.error=((s=(t=o.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to download file",console.error("Download file error:",o),o}})},getPreviewUrl(e){var t;return!e||!e.id||![...this.supportedFormats.images,"pdf"].includes((t=e.file_extension)==null?void 0:t.toLowerCase())?null:`${x.defaults.baseURL}/files/${e.id}/preview`},getThumbnailUrl(e){var l;return!e||!e.id||!this.supportedFormats.images.includes((l=e.file_extension)==null?void 0:l.toLowerCase())?null:`${x.defaults.baseURL}/files/${e.id}/thumbnail`},clearUploadQueue(){this.uploadQueue=[]},removeUploadItem(e){this.uploadQueue=this.uploadQueue.filter(l=>l.id!==e)},updateFilters(e){this.filters=z(z({},this.filters),e)},clearFilters(){this.filters={search:"",category:"",project_id:null,file_type:"",date_from:null,date_to:null}},setPage(e){this.pagination.current_page=e},setPerPage(e){this.pagination.per_page=e,this.pagination.current_page=1},clearCurrentFile(){this.currentFile=null},clearData(){this.files=[],this.currentFile=null,this.uploadQueue=[],this.error=null,this.pagination={current_page:1,per_page:20,total:0,last_page:1}},formatFileSize(e){if(e===0)return"0 Bytes";const l=1024,t=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(l));return parseFloat((e/Math.pow(l,s)).toFixed(2))+" "+t[s]}}}),Ce={class:"file-upload-container"},je={class:"upload-section"},xe={class:"project-option"},ke={key:0,class:"p-error"},Se={class:"upload-section"},ze={class:"upload-header"},$e={class:"upload-actions"},Le={class:"upload-info"},Pe={class:"file-count"},Me={class:"upload-content"},Be={key:0,class:"drop-area"},Ve={class:"drop-content"},Re={key:1,class:"file-list"},De={class:"file-preview"},Ee=["src","alt"],Qe={key:1,class:"file-icon"},Te={class:"file-details"},Oe={class:"file-info"},Ie={class:"file-name"},Ne={class:"file-size"},Ae={class:"file-meta"},Ge={class:"file-meta-row"},He={class:"file-meta-row"},Ke={class:"file-actions"},qe={key:0,class:"upload-section"},Je={class:"upload-progress"},We={class:"progress-header"},Xe={key:0,class:"current-upload"},Ye={key:1,class:"upload-section"},Ze={class:"upload-results"},et={class:"result-details"},tt={class:"dialog-footer"},I=50*1024*1024,lt=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt,.dwg,.zip,.rar",st={__name:"FileUpload",props:{visible:{type:Boolean,default:!1},projectId:{type:[String,Number],default:null}},emits:["update:visible","files-uploaded"],setup(e,{emit:l}){const t=e,s=l,o=fe(),u=Ue(),d=ye(),c=m(),p=m(t.projectId),F=m(!1),N=m([]),k=m([]),U=m([]),S=m(!1),P=m(0),M=m(0),D=m(0),B=m(""),C=m([]),V=m(!1),Q=J({get:()=>t.visible,set:i=>s("update:visible",i)}),ee=J(()=>p.value&&k.value.length>0&&!S.value),te=[{label:"Blueprints",value:"blueprints"},{label:"Documents",value:"documents"},{label:"Images",value:"images"},{label:"Reports",value:"reports"},{label:"Contracts",value:"contracts"},{label:"Invoices",value:"invoices"},{label:"Other",value:"other"}],A=()=>b(null,null,function*(){F.value=!0;try{yield o.fetchProjects({per_page:100}),N.value=o.projects.map(i=>({id:i.id,name:i.name,client_name:i.client_name}))}catch(i){console.error("Error loading projects:",i),d.add({severity:"error",summary:"Error",detail:"Failed to load projects",life:3e3})}finally{F.value=!1}}),le=()=>{V.value=!1},se=i=>{k.value=i.files,U.value=i.files.map(r=>({category:u.getFileCategory(r.name),description:""}))},ae=i=>{const r=i.files;U.value=U.value.filter((n,g)=>g<r.length)},oe=i=>{d.add({severity:"error",summary:"Upload Error",detail:i.error,life:5e3})},re=i=>{},ie=()=>b(null,null,function*(){if(!p.value){V.value=!0;return}if(k.value.length===0){d.add({severity:"warn",summary:"No Files",detail:"Please select files to upload",life:3e3});return}S.value=!0,P.value=0,M.value=0,D.value=k.value.length,C.value=[];try{for(let n=0;n<k.value.length;n++){const g=k.value[n],f=U.value[n];B.value=g.name;try{yield u.uploadSingleFile({file:g,projectId:p.value,category:f.category,description:f.description}),C.value.push({filename:g.name,status:"success",message:"Uploaded successfully"})}catch(j){C.value.push({filename:g.name,status:"error",message:j.message||"Upload failed"})}M.value++,P.value=M.value/D.value*100}const i=C.value.filter(n=>n.status==="success").length,r=C.value.filter(n=>n.status==="error").length;i>0&&(d.add({severity:"success",summary:"Upload Complete",detail:`${i} file(s) uploaded successfully${r>0?`, ${r} failed`:""}`,life:5e3}),s("files-uploaded",C.value.filter(n=>n.status==="success")))}catch(i){console.error("Upload error:",i),d.add({severity:"error",summary:"Upload Failed",detail:"An error occurred during upload",life:5e3})}finally{S.value=!1,B.value=""}}),G=()=>{k.value=[],U.value=[],P.value=0,M.value=0,D.value=0,B.value="",C.value=[],V.value=!1,c.value&&c.value.clear()},T=i=>{if(i===0)return"0 Bytes";const r=1024,n=["Bytes","KB","MB","GB"],g=Math.floor(Math.log(i)/Math.log(r));return parseFloat((i/Math.pow(r,g)).toFixed(2))+" "+n[g]},H=i=>["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(i.type),ne=i=>H(i)?URL.createObjectURL(i):null,de=i=>{var g;const r=(g=i.split(".").pop())==null?void 0:g.toLowerCase();return{pdf:"pi pi-file-pdf",doc:"pi pi-file-word",docx:"pi pi-file-word",xls:"pi pi-file-excel",xlsx:"pi pi-file-excel",txt:"pi pi-file",dwg:"pi pi-file",zip:"pi pi-file-import",rar:"pi pi-file-import"}[r]||"pi pi-file"};return W(()=>t.visible,i=>{i&&(A(),p.value=t.projectId,G())}),W(()=>t.projectId,i=>{p.value=i}),me(()=>{t.visible&&A()}),(i,r)=>(v(),he(_(_e),{visible:Q.value,"onUpdate:visible":r[2]||(r[2]=n=>Q.value=n),header:"Upload Files",modal:!0,draggable:!1,resizable:!1,class:"file-upload-dialog",onHide:G},{footer:$(()=>[a("div",tt,[w(_(R),{label:"Cancel",severity:"secondary",onClick:r[1]||(r[1]=n=>Q.value=!1),disabled:S.value},null,8,["disabled"]),w(_(R),{label:"Upload Files",loading:S.value,onClick:ie,disabled:!ee.value,icon:"pi pi-upload"},null,8,["loading","disabled"])])]),default:$(()=>[a("div",Ce,[a("div",je,[r[3]||(r[3]=a("h4",null,"Select Project",-1)),w(_(Z),{modelValue:p.value,"onUpdate:modelValue":r[0]||(r[0]=n=>p.value=n),options:N.value,optionLabel:"name",optionValue:"id",placeholder:"Select a project",loading:F.value,invalid:!p.value&&V.value,class:"w-full",onChange:le},{option:$(({option:n})=>[a("div",xe,[a("strong",null,h(n.name),1),a("small",null,h(n.client_name),1)])]),_:1},8,["modelValue","options","loading","invalid"]),!p.value&&V.value?(v(),y("small",ke,"Please select a project")):L("",!0)]),a("div",Se,[r[10]||(r[10]=a("h4",null,"Upload Files",-1)),w(_(Fe),{ref_key:"fileUploadRef",ref:c,multiple:!0,fileLimit:20,maxFileSize:I,accept:lt,customUpload:!0,onUploader:re,onSelect:se,onRemove:ae,onError:oe,class:"custom-file-upload"},{header:$(({chooseCallback:n,clearCallback:g,files:f})=>[a("div",ze,[a("div",$e,[w(_(R),{onClick:j=>n(),icon:"pi pi-plus",label:"Choose Files",class:"p-button-outlined"},null,8,["onClick"]),w(_(R),{onClick:j=>g(),icon:"pi pi-times",label:"Clear All",severity:"secondary",disabled:!f||f.length===0,class:"p-button-outlined"},null,8,["onClick","disabled"])]),a("div",Le,[a("span",Pe,h((f==null?void 0:f.length)||0)+" file(s) selected",1),a("small",null,"Max "+h(T(I))+" per file",1)])])]),content:$(({files:n,removeFileCallback:g})=>[a("div",Me,[!n||n.length===0?(v(),y("div",Be,[a("div",Ve,[r[4]||(r[4]=a("i",{class:"pi pi-cloud-upload drop-icon"},null,-1)),r[5]||(r[5]=a("h3",null,"Drop files here or click to browse",-1)),r[6]||(r[6]=a("p",null,"Supported formats: Images, PDFs, Documents",-1)),a("p",null,"Maximum file size: "+h(T(I)),1)])])):L("",!0),n&&n.length>0?(v(),y("div",Re,[(v(!0),y(X,null,Y(n,(f,j)=>(v(),y("div",{key:f.name+f.size,class:"file-item"},[a("div",De,[H(f)?(v(),y("img",{key:0,src:ne(f),alt:f.name,class:"file-thumbnail"},null,8,Ee)):(v(),y("div",Qe,[a("i",{class:O(de(f.name))},null,2)]))]),a("div",Te,[a("div",Oe,[a("strong",Ie,h(f.name),1),a("span",Ne,h(T(f.size)),1)]),a("div",Ae,[a("div",Ge,[r[7]||(r[7]=a("label",null,"Category:",-1)),w(_(Z),{modelValue:U.value[j].category,"onUpdate:modelValue":E=>U.value[j].category=E,options:te,optionLabel:"label",optionValue:"value",placeholder:"Select category",class:"category-dropdown"},null,8,["modelValue","onUpdate:modelValue"])]),a("div",He,[r[8]||(r[8]=a("label",null,"Description:",-1)),w(_(be),{modelValue:U.value[j].description,"onUpdate:modelValue":E=>U.value[j].description=E,placeholder:"File description (optional)",class:"description-input"},null,8,["modelValue","onUpdate:modelValue"])])])]),a("div",Ke,[w(_(R),{onClick:E=>g(j),icon:"pi pi-times",severity:"danger",text:"",rounded:"","aria-label":"Remove file"},null,8,["onClick"])])]))),128))])):L("",!0)])]),empty:$(()=>r[9]||(r[9]=[a("div",{class:"empty-content"},[a("i",{class:"pi pi-file-o empty-icon"}),a("p",null,"Drag and drop files here or click to browse.")],-1)])),_:1},512)]),S.value?(v(),y("div",qe,[r[11]||(r[11]=a("h4",null,"Upload Progress",-1)),a("div",Je,[a("div",We,[a("span",null,"Uploading "+h(M.value)+" of "+h(D.value)+" files",1),a("span",null,h(Math.round(P.value))+"%",1)]),w(_(we),{value:P.value,showValue:!1,class:"upload-progress-bar"},null,8,["value"]),B.value?(v(),y("div",Xe,[a("small",null,"Current: "+h(B.value),1)])):L("",!0)])])):L("",!0),C.value.length>0?(v(),y("div",Ye,[r[12]||(r[12]=a("h4",null,"Upload Results",-1)),a("div",Ze,[(v(!0),y(X,null,Y(C.value,n=>(v(),y("div",{key:n.filename,class:O(["result-item",`result-${n.status}`])},[a("i",{class:O(n.status==="success"?"pi pi-check-circle":"pi pi-times-circle")},null,2),a("div",et,[a("strong",null,h(n.filename),1),a("small",null,h(n.message),1)])],2))),128))])])):L("",!0)])]),_:1},8,["visible"]))}},gt=ve(st,[["__scopeId","data-v-f24b7dd4"]]);export{gt as F,Ue as u};
